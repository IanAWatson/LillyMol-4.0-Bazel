# Ring Replacement

## Purpose
Two separate tools combine to build a workflow for extracting rings and ring
systems from a set of known molecules. These extracted rings and ring systems
can then be used to replace the existing rings in a new molecule, with rings
of the same type and bonding pattern.

Processing is done in two phases.

1. Run `ring_extraction` on one or more collections of molecules containing
'donor' rings.
2. Run `ring_replacement`, providing it the 'donor' rings from 1, and input molecules
whose rings will be replaced by comparable rings from the 'donor' set.

Step 1 is done once, and step 2 can be done any number of times, using the
files generated by in step 1.

## Usage
A typical step 1 might be
```
ring_extraction -S RINGS -c -l -v chembl.smi
```
and a typical step 2 might be
```
ring_replacement -v -R RINGS_5a6a.smi flubendazole.smi
```
That particular molecule
```
OC(=O)NC1=NC2=C(N1)C=C(C=C2)C(=O)C1=CC=C(F)C=C1
```
has a fused 5/6 aromatic ring system, and so the file `RINGS_5a6a.smi` is used. This
invocation should generate more than 90 replaced forms. The first result is
```
OC(=O)N[1C]1=CC2=C(C=C[1N+](=C2)C(=O)C2=CC=C(F)C=C2)N1 flubendazole %% CHEMBL4302852 2
```
which shows that our starting molecule has combined with donor CHEMBL4302852, and that
there are two molecules in ChEMBL that contain that ring and substitution pattern. See
the discussion of support below.

In general, identify the kind
of ring/ring system you wish to replace, and provide that file, or files to `ring_replacement`
via one or more -R options.
```
ring_replacement -R RINGS_5a6a.smi -R RINGS_6a flubendazole > flubendazole.replacement.smi
```
This generates about 1700 resulting molecules. Unfortunately, about 90 of them come from
the benzimidazole ring, and 1600 come from the benzene ring. Combinations are not
formed directly. If you wish to have both rings replaced simultaneously, try something like
```
ring_replacement -u -v -R RINGS/RINGS_5a6a.smi flubendazole.smi | ring_replacement -R RINGS/RINGS_6a.smi -v -
```
Where the output from replacing the benzimidazole ring is then piped into an
invocation that replaces the benzene ring. This yields roughly 4400 new molecules.

## Support
While there might be a large number of examples of some rings, there are also a
great many rings that have very few exemplars in collections like ChEMBL. For a ring
that has, say, 3 different ChEMBL molecules ecemplifying that ring, we must ask whether
or not that structure is correct or not? The files of donor rings contain the number
of donor molecules that exemplify that ring. Generally I would recommend NOT using
rings that have fewer than 5 or 10 exemplified structures. Even if these rings are
less common, they might be harder to make. The number of donor molecules is included
in the output from ring_replacement. Specify the support level via the `-n` option to
`ring_replacement`. Specifying a higher value will have the added benefit of making
the processing faster.

The `-w` option to `ring_replacement` can be used to sort the output by number
of donor molecules.

## Atom types.
You may with to preserve the context of the ring. For example if the starting
molecule has an OH group, you might only want to consider replacements where
the donor/replacement ring also had an OH group at that position too. In that
case we need to build the database with atom typing and then use that same
atom typing when doing replacements.

In this case, we use an atom typing that consists of just number of connections and
atomic number, although generally I think there might be better choices.

```
ring_extraction -S RINGS -P UST:CY -c -l -v chembl.smi
```
```
ring_replacement -R RINGS_5a6a.smi -P UST:CY flubendazole.smi
```
Things will silently fail, no matches, unless the atom types used during
database building and querying are the same. Clearly it would be desirable
to make this more robust.

## Specifics

### ring_extraction
The help message for `ring_extraction` is
```
Extracts rings and ring systems creating ReplacementRing protos that can be used by ring_replacement
 -S <stem>         create ring data files with <stem>
 -R <rsize>        max ring size to process (def 7)
 -k                also generate smarts with connectivity not specified
 -x                transform within ring aliphatic double bonds to type any
 -P <atype>        label atoms by atom type of exocyclic attached atom
 -X ...            more options
 -c                remove chirality
 -l                strip to largest fragment
 -v                verbose output

```

On a fairly recent computer, processing ChEMBL will take about 94 seconds to process 2.16M molecules,
generating 52.7k unique ring and ring systems. 157 seconds on an older computer. Note
that the 52.7k unique rings differentiate between different substitution patterns.

The `-l` option means reduce to the largest fragment, and the `-c`
option says remove chirality from the input molecules.

### Files
The output is a series of files, starting with whatever was given to the `-S` option of
`ring_extraction`. You will see files like `CHEMBL_5a.smi`. This file contains five membered
aromatic rings from Chembl. A typical record might look like
```
smi: "O1[1CH]=CC=C1" smt: "[ax2r5D2]1:[ax2r5D>2]:[ax2r5D2]:[ax2r5D2]:[ax2r5D2]:1" id: "CHEMBL1445555" n: 37301 conn: true usmi: "o1[1cH]ccc1" 
```

This is a `ReplacementRing` proto, in text format.

The `smi` attribute is the smiles of the replacement ring, with isotopes showing the
attachment points. 

The `smt` attachment is a smarts for the ring, with the atoms in the smarts
being in the same order as the atoms in the smiles. This last point is crucial
to how this works.

`id` is the name of the first molecule where this ring was encountered, the donor,
and `n` is the number of molecules in the collection containing this ring - with this
substitution pattern. In this case, this particular record is the most common
five membered aromatic ring.

The files are named according to a convention. `a` refers to an aromatic ring, and
`A` refers to an aliphatic ring. So `CHEMBL_5a6a.smi` contains 5/6 fused aromatic
ring systems. By convention, ring systems are named in increasing ring size, and
aromatic before aliphatic. Take a look at structures included with the files to
make sure you understand what this naming.

### ring_replacement
The usage message for `ring_replacement` is,
```
 -R <fname>    file of labelled rings created by ring_extraction
 -s <smarts>   only replace rings matched by <smarts>
 -q <query>    only replace rings matched by <query>
 -u            unique molecules only
 -a            allow change of aromaticity on ring replacement
 -p            write parent molecule
 -n <ex>       only process replacement rings with <ex> or more examples
 -Y <query>    product molecules MUST     match a query in <query>
 -N <query>    product molecules must NOT match any queries in <query>
 -D <query>    discard any replacement ring that matches <query>
 -I .          remove isotopes from product molecules
 -I <n>        change all existing isotopes to <n> (useful if atom types used)
 -w            sort output by precedent count
 -X ...        more options
 -c            remove chirality
 -l            strip to largest fragment
```
The most important option is the `-R` option, which allows one or more replacement
ring specifications to be provided. This should be expanded to allow either a
file containing a list of rings, or a wildcard.

The `-s` and `-q` options enable specifying just which ring in the recipient
is to be replaced. You might be want to replace a `5a6a` type ring system, but
your input molecule contains two such rings. Use these options to specify
which one.

If there are kinds of replacement rings you do NOT want, use the `-D` option.
```
ring_replacement -D 'SMARTS:c=O' ...
```
will discard any replacement rings that have a `c=O` group.

The `-Y` and `-N` options apply positive and negative substructure selections
on the generated molecules. This is functionally equivalent to piping the
results of the replacement into `tsubstructure` and filtering there.

Currently the tool always writes the parent molecule so the `-p` option
is not being used. I will be fixing that...

The `-n` option allows specifying the support level. See above.

The `-I` option is used to alter or remove any isotopes that may be in
the product molecules. `-I .` removes isotopes, whereas providing any
number, `-I 1`, will transform any existing isotope to 1. This last case
will likely be useful in the case of atom typing, in which case the
atoms will have isotopes corresponding to atom types.
